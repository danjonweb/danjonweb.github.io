<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="./css/font.css" type="text/css" charset="utf-8"/>
    <title>Game</title>
    <script src="./js/jquery-2.1.1.min.js"></script>
    <script src="./js/jquery-ui.min.js"></script>
    <script src="./js/jquery.ui.touch-punch.min.js"></script>
    <script type='application/javascript' src='js/fastclick.js'></script>
    <script type="text/javascript">
        function isRetina() {
            return ((window.matchMedia && (window.matchMedia('only screen and (min-resolution: 124dpi), only screen and (min-resolution: 1.3dppx), only screen and (min-resolution: 48.8dpcm)').matches || window.matchMedia('only screen and (-webkit-min-device-pixel-ratio: 1.3), only screen and (-o-min-device-pixel-ratio: 2.6/2), only screen and (min--moz-device-pixel-ratio: 1.3), only screen and (min-device-pixel-ratio: 1.3)').matches)) || (window.devicePixelRatio && window.devicePixelRatio > 1.3));
        }
    
        var ENTITIES = [];

        var LEVEL;

        LEVEL = {
            "tileset": "tileset0",
            "layer0": [100, 110, 86, 111, 100, 97, 100, 100, 100, 100, 100, 98, 54, 99, 110, 111, 100, 97, 100, 100, 86, 87, 0, 85, 87, 85, 86, 86, 86, 86, 0, 0, 39, 27, 27, 43, 0, 0, 36, 37, 88, 0, 0, 0, 102, 35, 0, 0, 45, 46, 0, 0, 0, 101, 0, 35, 0, 44, 0, 0, 0, 0, 41, 27, 27, 28, 0, 0, 44, 0, 88, 0, 34, 0, 102, 0, 0, 0, 0, 0, 0, 76, 34, 0, 89, 0, 0, 0, 0, 0, 0, 0, 26, 27, 27, 63, 0, 0, 0, 0],
            "layer1": [-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 1002, -1, -1, 18, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 1, -1, -1, 18, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 1, -1, -1, 1005, -1, -1, -1, -1],
            "layer2": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0]
        };

        var COLLECTED_ITEMS = [];

        var IMAGES;
        if (!isRetina()) {
            IMAGES = {
                'player-gray': 'gray-player0-64.png',
                'player-blue': 'blue-player0-64.png',
                'tileset0': 'tileset0-64.png',
                'tileset1': 'tileset1-64.png',
                'tileset2': 'tileset2-64.png',
                'items': 'items-64.png'
            }
        } else {
            IMAGES = {
                'player-gray': 'gray-player0-64.png',
                'player-blue': 'blue-player0-64.png',
                'tileset0': 'tileset0-128.png',
                'tileset1': 'tileset1-128.png',
                'tileset2': 'tileset2-128.png',
                'items': 'items-64.png'
            }
        }
        var NUMBER_OF_IMAGES = 6;
        var NUMBER_OF_LOADED_IMAGES = 0;

        var CELL_WIDTH = 64;
        var CELL_HEIGHT = 64;
        var MAP_WIDTH = 10;
        var MAP_HEIGHT = 10;

        var PLAYER;
        var GAME_TIMER;
        var TIMER_SPEED = 20;
        var GAME_CANVAS;
        var GAME_CONTEXT;
        var GAME_COUNT;
        var IS_EXE = false;
        // When choosing commands
        var CLICKED_PART;
        var CLICKED_INDEX;
        // When executing commands
        var EXE_PART = 'main';
        var EXE_INDEX = -1;
        var EXE_CALLER_PARTS = []; // stack of callers
        var EXE_CALLER_INDEXES = []; // stack of indexes
        var EXE_TIMER;
        var COMMAND_SPEED = 600;

        function cellAboveCell(n) {
            if (n === -1) {
                return -1;
            }
            if (n - MAP_WIDTH >= 0) {
                return n - MAP_WIDTH;
            } else {
                return -1;
            }
        }

        function cellBelowCell(n) {
            if (n === -1) {
                return -1;
            }
            if (n + MAP_WIDTH < MAP_WIDTH * MAP_HEIGHT) {
                return n + MAP_WIDTH;
            } else {
                return -1;
            }
        }

        function cellLeftOfCell(n) {
            if (n === -1) {
                return -1;
            }
            var currentRow = Math.floor(n / MAP_WIDTH);
            var newPos = n - 1;
            var newRow = Math.floor(newPos / MAP_WIDTH);
            if (currentRow != newRow) {
                return -1;
            } else {
                return newPos;
            }
        }

        function cellRightOfCell(n) {
            if (n === -1) {
                return -1;
            }
            var currentRow = Math.floor(n / MAP_WIDTH);
            var newPos = n + 1;
            var newRow = Math.floor(newPos / MAP_WIDTH);
            if (currentRow != newRow) {
                return -1;
            } else {
                return newPos;
            }
        }
        function Player() {
            this.xPos = 0;
            this.yPos = 0;
            this.width = 64;
            this.height = 64;
            this.direction = 's';
            this.reset();
        }
        Player.prototype.reset = function () {
            this.current_frame = 0;
            this.start_frame = 0;
            this.end_frame = 0;
            this.skip = 6; // lower is faster
            this.isMoving = false;
            this.isJumping = false;
            this.requestStop = false;

            this.xSpeed = 0;
            this.ySpeed = 0;
            this.speed = 4;
            this.distance = 0;
            this.scale = 1;

            this.color = 'gray';
            this.source = IMAGES['player-' + this.color];

            // Determine starting position from layer1
            // 1001 = player facing north
            // 1002 = player facing east
            // 1003 = player facing south
            // 1004 = player facing west
            for (var i = 0; i < LEVEL['layer1'].length; i++) {
                if (LEVEL['layer1'][i] == 1001 || LEVEL['layer1'][i] == 1002 || LEVEL['layer1'][i] == 1003 || LEVEL['layer1'][i] == 1004) {
                    var x = (i % MAP_WIDTH) * CELL_WIDTH;
                    var y = Math.floor(i / MAP_WIDTH) * CELL_HEIGHT;
                    this.xPos = x;
                    this.yPos = y;
                    switch (LEVEL['layer1'][i]) {
                        case 1001:
                            this.faceNorth();
                            break;
                        case 1002:
                            this.faceEast();
                            break;
                        case 1003:
                            this.faceSouth();
                            break;
                        case 1004:
                            this.faceWest();
                            break;
                        default:
                            break;
                    }
                    break;
                }
            }
        }
        Player.prototype.changeColor = function (color) {
            this.color = color;
            this.source = IMAGES['player-' + color];
        }
        Player.prototype.stop = function () {
            if (this.direction === 'n') {
                this.faceNorth();
            } else if (this.direction === 'e') {
                this.faceEast();
            } else if (this.direction === 's') {
                this.faceSouth();
            } else if (this.direction === 'w') {
                this.faceWest();
            }
            console.log(this.distance);
        }
        Player.prototype.faceNorth = function () {
            this.isMoving = false;
            this.direction = 'n';
            this.current_frame = 6;
            this.start_frame = 6;
            this.end_frame = 8;
        }
        Player.prototype.faceEast = function () {
            this.isMoving = false;
            this.direction = 'e';
            this.current_frame = 3;
            this.start_frame = 3;
            this.end_frame = 5;
        }
        Player.prototype.faceSouth = function () {
            this.isMoving = false;
            this.direction = 's';
            this.current_frame = 0;
            this.start_frame = 0;
            this.end_frame = 2;
        }
        Player.prototype.faceWest = function () {
            this.isMoving = false;
            this.direction = 'w';
            this.current_frame = 9;
            this.start_frame = 9;
            this.end_frame = 11;
        }
        function cellIsBlocked(n) {
            var isBlocked = false;
            if (n === -1) {
                isBlocked = true;
            } else {
                if (LEVEL['layer2'][n] === 0) {
                    isBlocked = true;
                }
            }
            return isBlocked;
        }
        Player.prototype.turnClockwise = function () {
            if (this.direction === 'n') {
                this.faceEast();
            } else if (this.direction === 'e') {
                this.faceSouth();
            } else if (this.direction === 's') {
                this.faceWest();
            } else if (this.direction === 'w') {
                this.faceNorth();
            }
        }
        Player.prototype.turnCounterClockwise = function () {
            if (this.direction === 'n') {
                this.faceWest();
            } else if (this.direction === 'e') {
                this.faceNorth();
            } else if (this.direction === 's') {
                this.faceEast();
            } else if (this.direction === 'w') {
                this.faceSouth();
            }
        }
        Player.prototype.pos = function () {
            var row = this.yPos / this.height;
            var col = this.xPos / this.width;
            var pos = row * MAP_WIDTH + col;
            return pos;
        }
        Player.prototype.nextPos = function () {
            // Returns next position based on current direction
            var pos = this.pos();
            var nextPos = -1;
            if (this.direction === 'n') {
                nextPos = cellAboveCell(pos);
            } else if (this.direction === 's') {
                nextPos = cellBelowCell(pos);
            } else if (this.direction === 'w') {
                nextPos = cellLeftOfCell(pos);
            } else if (this.direction === 'e') {
                nextPos = cellRightOfCell(pos);
            }
            return nextPos;
        }
        Player.prototype.nextNextPos = function () {
            var pos = this.pos();
            var nextPos = -1;
            if (this.direction === 'n') {
                nextPos = cellAboveCell(pos);
                nextPos = cellAboveCell(nextPos);
            } else if (this.direction === 's') {
                nextPos = cellBelowCell(pos);
                nextPos = cellBelowCell(nextPos);
            } else if (this.direction === 'w') {
                nextPos = cellLeftOfCell(pos);
                nextPos = cellLeftOfCell(nextPos);
            } else if (this.direction === 'e') {
                nextPos = cellRightOfCell(pos);
                nextPos = cellRightOfCell(nextPos);
            }
            return nextPos;
        }
        Player.prototype.move = function () {
            if (cellIsBlocked(this.nextPos())) {
                return;
            }
            this.isMoving = true;
            this.requestStop = false;
            this.distance = 0;
            if (this.direction === 'n') {
                this.xSpeed = 0;
                this.ySpeed = -this.speed;
            } else if (this.direction === 'e') {
                this.xSpeed = this.speed;
                this.ySpeed = 0;
            } else if (this.direction === 's') {
                this.xSpeed = 0;
                this.ySpeed = this.speed;
            } else if (this.direction === 'w') {
                this.xSpeed = -this.speed;
                this.ySpeed = 0;
            }
        }
        Player.prototype.jump = function () {
            if (cellIsBlocked(this.nextNextPos())) {
                return;
            }
            this.isJumping = true;
            this.requestStop = false;
            this.distance = 0;
            this.scale = 1;
            if (this.direction === 'n') {
                this.xSpeed = 0;
                this.ySpeed = -this.speed * 2;
            } else if (this.direction === 'e') {
                this.xSpeed = this.speed * 2;
                this.ySpeed = 0;
            } else if (this.direction === 's') {
                this.xSpeed = 0;
                this.ySpeed = this.speed * 2;
            } else if (this.direction === 'w') {
                this.xSpeed = -this.speed * 2;
                this.ySpeed = 0;
            }
        }
        Player.prototype.action = function () {
            //console.log(LEVEL['layer1'][this.pos()]);
            var item = LEVEL['layer1'][this.pos()];
            if (item >= 0 && item < 1000) {
                if (item === 1) {
                    // blue
                    this.changeColor('blue');
                } else if (item === 18) {
                    // gray
                    this.changeColor('gray');
                }
                COLLECTED_ITEMS.push(this.pos());
            }
        }
        Player.prototype.update = function (c, count) {
            // Draw current frame

            var wRatio = CELL_WIDTH / this.width;
            var hRatio = CELL_HEIGHT / this.height;
            var ratio = Math.min(wRatio, hRatio);
            var newWidth = Math.floor(this.width * ratio);
            var newHeight = Math.floor(this.height * ratio);

            var pr = window.devicePixelRatio;

            var xOffset = this.xPos - 0.5 * (newWidth * this.scale - newWidth);
            var yOffset = this.yPos - 0.5 * (newHeight * this.scale - newHeight);

            c.drawImage(this.source, this.current_frame * this.width * pr, 0, this.width * pr, this.height * pr, xOffset, yOffset, newWidth * this.scale, newHeight * this.scale);

            if (this.requestStop) {
                // Stop is requested -- cycle through animation until first frame is reached, then set isMoving to false.
                if (this.current_frame !== this.start_frame) {
                    // Advance to next frame of animation
                    this.current_frame = this.current_frame + 1 > this.end_frame ? this.start_frame : this.current_frame + 1;
                } else {
                    this.isMoving = false;
                    this.isJumping = false;
                    this.distance = 0;
                    this.requestStop = false;
                    this.scale = 1;
                }
            } else if (this.isMoving) {
                if (count % this.skip === 0) {
                    // Advance to next frame of animation
                    this.current_frame = this.current_frame + 1 > this.end_frame ? this.start_frame : this.current_frame + 1;
                }
                // Move the position if max distance hasn't been reached for last move
                var maxDistance = (this.direction === 'n' || this.direction === 's') ? CELL_WIDTH : CELL_HEIGHT;
                if (this.distance < maxDistance) {
                    this.xPos += this.xSpeed;
                    this.yPos += this.ySpeed;
                    this.distance += (Math.abs(this.xSpeed) + Math.abs(this.ySpeed));
                } else {
                    this.requestStop = true;
                }

            } else if (this.isJumping) {

                this.current_frame = this.start_frame + 1;

                var maxDistance = (this.direction === 'n' || this.direction === 's') ? 2 * CELL_WIDTH : 2 * CELL_HEIGHT;
                if (this.distance < maxDistance) {
                    this.xPos += this.xSpeed;
                    this.yPos += this.ySpeed;
                    this.distance += (Math.abs(this.xSpeed) + Math.abs(this.ySpeed));
                    this.scale = -0.0001 * Math.pow(this.distance, 2) + 0.0083 * (this.distance) + 1;
                } else {
                    this.requestStop = true;
                }
            }

        }


        function redraw() {
            // clear the canvas for this loop's animation
            GAME_CONTEXT.clearRect(0, 0, GAME_CANVAS.width, GAME_CANVAS.height);

            // Draw map
            for (var i = 0; i < LEVEL['layer0'].length; i++) {

                var x = (i % MAP_WIDTH) * CELL_WIDTH;
                var y = Math.floor(i / MAP_WIDTH) * CELL_HEIGHT;
                var pr = window.devicePixelRatio;

                GAME_CONTEXT.drawImage(IMAGES[LEVEL.tileset], LEVEL['layer0'][i] * CELL_WIDTH * pr, 0, CELL_WIDTH * pr, CELL_HEIGHT * pr, x, y, CELL_WIDTH, CELL_HEIGHT);

                if (LEVEL['layer1'][i] !== -1 && COLLECTED_ITEMS.indexOf(i) === -1) {
                    GAME_CONTEXT.drawImage(IMAGES['items'], LEVEL['layer1'][i] * CELL_WIDTH * pr, 0, CELL_WIDTH * pr, CELL_HEIGHT * pr, x, y, CELL_WIDTH, CELL_HEIGHT);
                }
            }

            // Draw items
            for (var i = 0; i < COLLECTED_ITEMS.length; i++) {
                var item = parseInt(LEVEL['layer1'][COLLECTED_ITEMS[i]]);
                GAME_CONTEXT.drawImage(IMAGES['items'], item * CELL_WIDTH * pr, 0, CELL_WIDTH * pr, CELL_HEIGHT * pr, i * CELL_WIDTH, CELL_HEIGHT * MAP_HEIGHT, CELL_WIDTH, CELL_HEIGHT);
            }

            // Draw grid
            GAME_CONTEXT.fillStyle = '#DDD';
            for (var i = 1; i < MAP_WIDTH; i++) {
                //GAME_CONTEXT.fillRect(i*CELL_WIDTH, 0, 1, GAME_CANVAS.height);
            }
            for (var i = 1; i < MAP_HEIGHT; i++) {
                //GAME_CONTEXT.fillRect(0, i*CELL_HEIGHT, GAME_CANVAS.width, 1);
            }

            for (var i = 0; i < ENTITIES.length; i++) {
                var e = ENTITIES[i];
                e.update(GAME_CONTEXT, GAME_COUNT);
            }

            GAME_COUNT = GAME_COUNT + 1 > 999 ? 0 : GAME_COUNT + 1;
        }
        function resetCommandBackgroundColors() {
            // Un-highlight all commands
            var allCommands = document.querySelectorAll('#main .command, #sub1 .command, #sub2 .command');
            for (var i = 0; i < allCommands.length; i++) {
                allCommands.item(i).style.backgroundColor = '#333';
            }
        }
        function executeNextCommand() {
            resetCommandBackgroundColors();

            var commands = document.querySelectorAll('#' + EXE_PART + ' .command');

            if (LEVEL['layer1'][PLAYER.pos()] === 1005) {
                // Arrived at end -- check that all items picked up
                var allItemsCollected = true;
                for (var i = 0; i < LEVEL['layer1'].length; i++) {
                    if (LEVEL['layer1'][i] >= 0 && LEVEL['layer1'][i] < 1000 && COLLECTED_ITEMS.indexOf(i) === -1) {
                        allItemsCollected = false;
                    }
                }
                if (allItemsCollected) {
                    alert('Finished!');
                    stop();
                    return;
                }
            }
            if (EXE_INDEX >= commands.length || commands.item(EXE_INDEX).dataset.command === '') {
                if (EXE_PART === 'sub1' || EXE_PART === 'sub2') {
                    EXE_PART = EXE_CALLER_PARTS.pop();
                    EXE_INDEX = EXE_CALLER_INDEXES.pop();
                    EXE_TIMER = setTimeout(executeNextCommand, 0);
                } else if (EXE_PART === 'main') {
                    IS_EXE = false;
                    clearInterval(GAME_TIMER);
                }
            } else {
                commands.item(EXE_INDEX).style.backgroundColor = '#E3E890';
                var command = commands.item(EXE_INDEX).dataset.command;
                var commandColor = commands.item(EXE_INDEX).dataset.color;
                // Always execute gray commands, or execute if command color = player color
                if (commandColor === 'gray' || commandColor === PLAYER.color) {
                    switch (command) {
                        case 'm':
                            PLAYER.move();
                            break;
                        case 'cw':
                            PLAYER.turnClockwise();
                            break;
                        case 'ccw':
                            PLAYER.turnCounterClockwise();
                            break;
                        case 'j':
                            PLAYER.jump();
                            break;
                        case 'a':
                            PLAYER.action();
                            break;
                        case 's1':
                            EXE_CALLER_PARTS.push(EXE_PART);
                            EXE_CALLER_INDEXES.push(++EXE_INDEX);
                            EXE_PART = 'sub1';
                            EXE_INDEX = -1;
                            break;
                        case 's2':
                            EXE_CALLER_PARTS.push(EXE_PART);
                            EXE_CALLER_INDEXES.push(++EXE_INDEX);
                            EXE_PART = 'sub2';
                            EXE_INDEX = -1;
                            break;
                        default:
                            break;
                    }
                }
                EXE_INDEX++;
                EXE_TIMER = setTimeout(executeNextCommand, COMMAND_SPEED);
            }
        }
        function start() {
            // Setup game canvas
            GAME_CANVAS = document.getElementById('game');
            if (GAME_CANVAS.getContext) {
                GAME_CONTEXT = GAME_CANVAS.getContext('2d');

                var bottomWidth = CELL_HEIGHT;
                if (!isRetina()) {
                    console.log('pr: 1');
                    GAME_CANVAS.width = CELL_WIDTH * MAP_WIDTH;
                    GAME_CANVAS.height = CELL_HEIGHT * MAP_HEIGHT + bottomWidth;
                    GAME_CANVAS.style.width = CELL_WIDTH * MAP_WIDTH;
                    GAME_CANVAS.style.height = CELL_HEIGHT * MAP_HEIGHT + bottomWidth;
                } else {
                    console.log('pr: 2');
                    GAME_CANVAS.width = 2 * CELL_WIDTH * MAP_WIDTH;
                    GAME_CANVAS.height = 2 * CELL_HEIGHT * MAP_HEIGHT + 2 * bottomWidth;
                    GAME_CANVAS.style.width = CELL_WIDTH * MAP_WIDTH;
                    GAME_CANVAS.style.height = CELL_HEIGHT * MAP_HEIGHT + bottomWidth;
                    GAME_CONTEXT.scale(2, 2);
                }

                GAME_COUNT = 0;

                redraw();
            }
        }
        function stop() {
            clearInterval(GAME_TIMER);
            clearTimeout(EXE_TIMER);
            IS_EXE = true;
            resetCommandBackgroundColors();
            redraw();
        }
        function onDeviceReady() {
            FastClick.attach(document.body);
        }
        function ready() {
            $('.command').draggable({ revert: true, revertDuration: 100, containment: "parent", zIndex: 100});
            $('.command').droppable({ accept: ".command", drop: function(event, ui) {
                this.dataset.command = ui.draggable[0].dataset.command;
                ui.draggable[0].dataset.command = "";
                this.style.backgroundColor = '#333';
            }, over: function(event, ui) {
                this.style.backgroundColor = '#E3E890';
            }, out: function(event, ui) {
                this.style.backgroundColor = '#333';
            }});
            
            // Fastclick
            document.addEventListener("deviceready", onDeviceReady, false);

            // Load images
            for (var key in IMAGES) {
                if (IMAGES.hasOwnProperty(key)) {
                    var path = IMAGES[key];
                    IMAGES[key] = new Image();
                    IMAGES[key].onload = function () {
                        NUMBER_OF_LOADED_IMAGES++;
                        if (NUMBER_OF_LOADED_IMAGES === NUMBER_OF_IMAGES) {
                            console.log(NUMBER_OF_LOADED_IMAGES)
                            start();
                        }
                    };
                    IMAGES[key].src = './img/' + path;
                }
            }

            // Add player object
            PLAYER = new Player();
            ENTITIES.push(PLAYER);

            document.getElementById('go').onclick = function () {
                if (IS_EXE) {
                    return;
                }
                IS_EXE = true;

                PLAYER.reset();
                COLLECTED_ITEMS = [];
                GAME_COUNT = 0;
                EXE_PART = 'main';
                EXE_INDEX = 0;
                EXE_CALLER_PARTS = [];
                EXE_CALLER_INDEXES = [];

                GAME_TIMER = setInterval(redraw, TIMER_SPEED);

                // First command takes half time to start
                EXE_TIMER = setTimeout(executeNextCommand, COMMAND_SPEED / 2);
            }
            document.getElementById('restart').onclick = function () {
                EXE_PART = 'main';
                EXE_INDEX = 0;
                EXE_CALLER_PARTS = [];
                EXE_CALLER_INDEXES = [];
                clearInterval(GAME_TIMER);
                clearTimeout(EXE_TIMER);
                IS_EXE = false;
                PLAYER.reset();
                COLLECTED_ITEMS = [];
                GAME_COUNT = 0;
                resetCommandBackgroundColors();
                redraw();
            }

            document.getElementById('command-chooser-close').onclick = function () {
                document.getElementById('command-chooser').style.display = 'none';
            }

            // Command blank
            var commandEvent = function () {
                if (this.dataset.command == '') {
                    CLICKED_PART = this.dataset.part;
                    CLICKED_INDEX = this.dataset.index;
                    document.getElementById('command-chooser').style.display = 'block';
                } else {
                    this.dataset.command = '';
                }
            }
            var list = document.getElementsByClassName('command');
            for (var i = 0; i < list.length; i++) {
                list.item(i).onclick = commandEvent;
                //list.item(i).touchstart = commandEvent;
            }

            // Command choose
            var commandChooseEvent = function () {
                document.querySelector('.command[data-part="' + CLICKED_PART + '"][data-index="' + CLICKED_INDEX + '"]').dataset.command = this.dataset.command;
                document.querySelector('.command[data-part="' + CLICKED_PART + '"][data-index="' + CLICKED_INDEX + '"]').dataset.color = this.dataset.color;
                document.getElementById('command-chooser').style.display = 'none';

            }
            list = document.getElementsByClassName('command-choose');
            for (var i = 0; i < list.length; i++) {
                list.item(i).onclick = commandChooseEvent;
                //list.item(i).touchstart = commandEvent;
            }


        }
    </script>
    <style type="text/css">
        body {
            font-family: 'early_gameboyregular', sans-serif;
            padding: 0;
            margin: 0;
            background-color: #333;
        }

        div#container {
            width: 840px;
            height: 100%;
            margin: 0 auto 0 auto;
            padding: 0;
        }

        canvas {
            float: left;
        }

        div#command-container {
            width: 200px;
            height: 460px;
            overflow: hidden;
            position: relative;
            box-sizing: border-box;
        }

        .section-title {
            font-size: 8px;
            color: white;
            text-align: center;
            border: 1px solid #FEFFFD;
            padding: 2px 0 2px 0;
            box-sizing: border-box;
        }

        .command {
            width: 25%;
            height: 45px;
            border: 1px solid #555;
            box-sizing: border-box;
            float: left;
            cursor: pointer;
            background-color: #333;
        }

        #command-chooser {
            position: absolute;
            top: 0;
            left: 0;
            width: 200px;
            height: 100%;
            background-color: #333;
            display: none;
        }

        input[type="button"] {
            height: 24px;
            border-radius: 0;
            min-width: 50px;
            padding: 3px;
            background-color: #FEFFFD;
            font-family: 'early_gameboyregular', sans-serif;
            font-size: 8px;
            border: 3px solid #AFB5A8;
            cursor: pointer;
        }

        .command[data-command="m"][data-color="gray"] {
            background-image: url('img/gray-forward@2x.png');
            background-repeat: no-repeat;
            background-position: center center;
            background-size: 32px 32px;
        }

        .command[data-command="cw"][data-color="gray"] {
            background-image: url('img/gray-turnLeft@2x.png');
            background-repeat: no-repeat;
            background-position: center center;
            background-size: 32px 32px;
        }

        .command[data-command="ccw"][data-color="gray"] {
            background-image: url('img/gray-turnRight@2x.png');
            background-repeat: no-repeat;
            background-position: center center;
            background-size: 32px 32px;
        }

        .command[data-command="j"][data-color="gray"] {
            background-image: url('img/gray-jump@2x.png');
            background-repeat: no-repeat;
            background-position: center center;
            background-size: 32px 32px;
        }

        .command[data-command="a"][data-color="gray"] {
            background-image: url('img/gray-scream@2x.png');
            background-repeat: no-repeat;
            background-position: center center;
            background-size: 32px 32px;
        }

        .command[data-command="s1"][data-color="gray"] {
            background: center center/32px 32px no-repeat url('img/gray-S1@2x.png');
        }

        .command[data-command="s2"][data-color="gray"] {
            background: center center/32px 32px no-repeat url('img/gray-S2@2x.png');
        }

        .command[data-command="m"][data-color="blue"] {
            background-image: url('img/blue-forward@2x.png');
            background-repeat: no-repeat;
            background-position: center center;
            background-size: 32px 32px;
        }

        .command[data-command="cw"][data-color="blue"] {
            background-image: url('img/blue-turnLeft@2x.png');
            background-repeat: no-repeat;
            background-position: center center;
            background-size: 32px 32px;
        }

        .command[data-command="ccw"][data-color="blue"] {
            background-image: url('img/blue-turnRight@2x.png');
            background-repeat: no-repeat;
            background-position: center center;
            background-size: 32px 32px;
        }

        .command[data-command="j"][data-color="blue"] {
            background-image: url('img/blue-jump@2x.png');
            background-repeat: no-repeat;
            background-position: center center;
            background-size: 32px 32px;
        }

        .command[data-command="a"][data-color="blue"] {
            background-image: url('img/blue-scream@2x.png');
            background-repeat: no-repeat;
            background-position: center center;
            background-size: 32px 32px;
        }

        .command[data-command="s1"][data-color="blue"] {
            background: center center/32px 32px no-repeat url('img/blue-S1@2x.png');
        }

        .command[data-command="s2"][data-color="blue"] {
            background: center center/32px 32px no-repeat url('img/blue-S2@2x.png');
        }
        
        @media only screen and (min-width: 500px) and (max-width: 840px) {
            div#container {
                width: 100%;
            }
            canvas {
                width: 70%;
                position: fixed;
            }
            div#command-container {
                width: 30%;
                float: right;
            }
        }
        
        @media only screen and (min-width: 0px) and (max-width: 500px) {
            div#container {
                width: 100%;
            }
            canvas {
                width: 60%;
                position: fixed;
            }
            div#command-container {
                width: 40%;
                float: right;
            }
        }
    </style>
</head>

<body onload="ready();">
<div id="container">
    <canvas id="game"></canvas>

    <div id="command-container">

        <div class="section" id="main">
            <div class="section-title">Main</div>
            <div class="command" data-part="main" data-index="0" data-command=""></div>
            <div class="command" data-part="main" data-index="1" data-command=""></div>
            <div class="command" data-part="main" data-index="2" data-command=""></div>
            <div class="command" data-part="main" data-index="3" data-command=""></div>

            <div class="command" data-part="main" data-index="4" data-command=""></div>
            <div class="command" data-part="main" data-index="5" data-command=""></div>
            <div class="command" data-part="main" data-index="6" data-command=""></div>
            <div class="command" data-part="main" data-index="7" data-command=""></div>

            <div class="command" data-part="main" data-index="8" data-command=""></div>
            <div class="command" data-part="main" data-index="9" data-command=""></div>
            <div class="command" data-part="main" data-index="10" data-command=""></div>
            <div class="command" data-part="main" data-index="11" data-command=""></div>

            <div class="command" data-part="main" data-index="12" data-command=""></div>
            <div class="command" data-part="main" data-index="13" data-command=""></div>
            <div class="command" data-part="main" data-index="14" data-command=""></div>
            <div class="command" data-part="main" data-index="15" data-command=""></div>

            <div style="clear: both;"></div>
        </div>

        <div class="section" id="sub1">
            <div class="section-title">Sub1</div>
            <div class="command" data-part="sub1" data-index="0" data-command=""></div>
            <div class="command" data-part="sub1" data-index="1" data-command=""></div>
            <div class="command" data-part="sub1" data-index="2" data-command=""></div>
            <div class="command" data-part="sub1" data-index="3" data-command=""></div>

            <div class="command" data-part="sub1" data-index="4" data-command=""></div>
            <div class="command" data-part="sub1" data-index="5" data-command=""></div>
            <div class="command" data-part="sub1" data-index="6" data-command=""></div>
            <div class="command" data-part="sub1" data-index="7" data-command=""></div>

            <div style="clear: both;"></div>
        </div>

        <div class="section" id="sub2">
            <div class="section-title">Sub2</div>
            <div class="command" data-part="sub2" data-index="0" data-command=""></div>
            <div class="command" data-part="sub2" data-index="1" data-command=""></div>
            <div class="command" data-part="sub2" data-index="2" data-command=""></div>
            <div class="command" data-part="sub2" data-index="3" data-command=""></div>

            <div class="command" data-part="sub2" data-index="4" data-command=""></div>
            <div class="command" data-part="sub2" data-index="5" data-command=""></div>
            <div class="command" data-part="sub2" data-index="6" data-command=""></div>
            <div class="command" data-part="sub2" data-index="7" data-command=""></div>

            <div style="clear: both;"></div>
        </div>
        <input type="button" value="Go" id="go"/>
        <input type="button" value="Restart" id="restart"/>


        <div id="command-chooser">
            <div class="section-title">Commands</div>
            <div class="command command-choose" data-command="m" data-color="gray"></div>
            <div class="command command-choose" data-command="cw" data-color="gray"></div>
            <div class="command command-choose" data-command="ccw" data-color="gray"></div>
            <div class="command command-choose" data-command="j" data-color="gray"></div>
            <div class="command command-choose" data-command="a" data-color="gray"></div>
            <div class="command command-choose" data-command="s1" data-color="gray"></div>
            <div class="command command-choose" data-command="s2" data-color="gray"></div>
            <div style="clear: both;"></div>
            <div class="command command-choose" data-command="m" data-color="blue"></div>
            <div class="command command-choose" data-command="cw" data-color="blue"></div>
            <div class="command command-choose" data-command="ccw" data-color="blue"></div>
            <div class="command command-choose" data-command="j" data-color="blue"></div>
            <div class="command command-choose" data-command="a" data-color="blue"></div>
            <div class="command command-choose" data-command="s1" data-color="blue"></div>
            <div class="command command-choose" data-command="s2" data-color="blue"></div>
            <div style="clear: both;"></div>
            <input id="command-chooser-close" type="button" value="OK"/>
        </div>

    </div>
    <div style="clear: both;"></div>
</div>
</body>

</html>